import nmap
import logging

def check_vulnerabilities(ip):
    '''
    Summary Description: This function scans a device with the given IP address for open ports,
                         identifies running services, and checks for known vulnerabilities.

    -- CONTROL FLOW
        -- The function uses the nmap.PortScanner to scan the specified IP address.
        -- It iterates through all protocols and ports to identify open ports and running services.
        -- Detected services are checked for known vulnerabilities and added to the list.

    -- INPUTS
        -- ip (str): The IP address of the device to scan.

    -- OUTPUTS
        -- vulnerabilities (list): A list of strings describing detected vulnerabilities,
                                   including open ports and services with potential issues.

    -- CONSTRAINTS
        -- Requires nmap to be installed on the system.
        -- The user must have the necessary permissions to perform network scans.
    '''
    logging.info(f"Checking vulnerabilities for {ip}...")
    nm = nmap.PortScanner()
    nm.scan(ip, arguments='-sV -p ' + ','.join(map(str, [21, 22, 23, 25, 53, 80, 110, 143, 443, 445])))
    vulnerabilities = []

    for proto in nm[ip].all_protocols():
    
        ports = nm[ip][proto].keys()
    
        for port in ports:
    
            service = nm[ip][proto][port]['name']
            product = nm[ip][proto][port]['product']
            version = nm[ip][proto][port]['version']
    
            if service in ["ftp", "ssh", "telnet", "smtp", "dns", "http", "pop3", "imap", "https", "microsoft-ds"]:
                vulnerabilities.append(f"Open {service} service on port {port}, product: {product}, version: {version}")
    
    logging.info(f"Vulnerability check for {ip} completed with {len(vulnerabilities)} vulnerabilities found.")
    
    return vulnerabilities