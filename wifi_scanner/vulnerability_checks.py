import nmap
import logging

def check_vulnerabilities(ip):
    '''
    Summary Description: This function scans a device with the given IP address for open ports,
                         identifies running services, and checks for known vulnerabilities.

    -- CONTROL FLOW
        -- The function uses the nmap.PortScanner to scan the specified IP address.
        -- It iterates through all protocols and ports to identify open ports and running services.
        -- Detected services are checked for known vulnerabilities and added to the list.

    -- INPUTS
        -- ip (str): The IP address of the device to scan.

    -- OUTPUTS
        -- vulnerabilities (list): A list of strings describing detected vulnerabilities,
                                   including open ports and services with potential issues.
        -- os_info (str): Operating system information of the device.

    -- CONSTRAINTS
        -- Requires nmap to be installed on the system.
        -- The user must have the necessary permissions to perform network scans.
    '''
    logging.info(f"Checking vulnerabilities for {ip}...")
    nm = nmap.PortScanner()
    # Use -A for comprehensive scan including OS detection and service version detection
    nm.scan(ip, arguments='-A -p 21,22,23,25,53,80,110,143,443,445')
    vulnerabilities = []

    os_info = "Unknown"
    os_details = "Unknown"

    if 'osclass' in nm[ip] and len(nm[ip]['osclass']) > 0:
        
        os_class = nm[ip]['osclass'][0]
        os_info = f"{os_class['osfamily']} {os_class['osgen']}"
        os_details = os_class.get('accuracy', 'Unknown')

    elif 'osmatch' in nm[ip] and len(nm[ip]['osmatch']) > 0:
        os_match = nm[ip]['osmatch'][0]
        os_info = os_match['name']
        os_details = os_match.get('accuracy', 'Unknown')

    else:
        logging.info(f"No OS information available for {ip}")

    for proto in nm[ip].all_protocols():
        ports = nm[ip][proto].keys()
        
        for port in ports:
            
            service = nm[ip][proto][port]['name']
            product = nm[ip][proto][port]['product']
            version = nm[ip][proto][port]['version']
            
            if service in ["ftp", "ssh", "telnet", "smtp", "dns", "http", "pop3", "imap", "https", "microsoft-ds"]:
                vulnerabilities.append(f"Open {service} service on port {port}, product: {product}, version: {version}")
    
    logging.info(f"Vulnerability check for {ip} completed with {len(vulnerabilities)} vulnerabilities found.")
    return vulnerabilities, os_info, os_details